# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python
import asyncio
import logging
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ParseMode
from telegram.ext import ApplicationBuilder, ContextTypes, CommandHandler, CallbackQueryHandler
import aiohttp
import json

# --- Settings ---

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN", "8045271874:AAGaTThRco-5ZnNIEmvEsLpf79hOzieVGZc")
PUMPFUN_API = "https://api.pump.fun/v1/tokens"
RUGCHECK_API = "https://api.rugcheck.xyz/api/check/"
GMGN_API = "https://api.gmgn.xyz/token/"
SENT_TOKENS_FILE = "sent_tokens.json"
AUTHORIZED_CHAT_ID = 7143072060  # Chat ID Ù„Ù€ @HB089

# --- Logging ---
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# --- Helper Function for Authorization ---

def is_authorized_chat(update: Update) -> bool:
    return update.effective_chat.id == AUTHORIZED_CHAT_ID

# --- Persistent Storage ---

def load_sent_tokens():
    try:
        with open(SENT_TOKENS_FILE, 'r') as f:
            return set(json.load(f))
    except FileNotFoundError:
        return set()

def save_sent_tokens(sent_tokens):
    with open(SENT_TOKENS_FILE, 'w') as f:
        json.dump(list(sent_tokens), f)

# --- API Functions ---

async def get_new_tokens(session: aiohttp.ClientSession):
    try:
        async with session.get(PUMPFUN_API) as response:
            data = await response.json()
            return data.get("tokens", [])
    except Exception as e:
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ù…Ù† PumpFun: {e}")
        return []

async def check_rug(session: aiohttp.ClientSession, token_address: str):
    try:
        async with session.get(RUGCHECK_API + token_address) as response:
            result = await response.json()
            return result.get("status") == "GOOD"
    except Exception as e:
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Rug: {e}")
        return False

async def analyze_token(session: aiohttp.ClientSession, token_address: str):
    try:
        async with session.get(GMGN_API + token_address) as response:
            data = await response.json()
            return {
                "liquidity": data.get("liquidity", "ØºÙŠØ± Ù…ØªÙˆÙØ±"),
                "owners": data.get("holders", "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),
                "market_cap": data.get("market_cap", "ØºÙŠØ± Ù…ØªÙˆÙØ±"),
                "age": data.get("age", "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),
                "trend": data.get("trend", "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),
                "price": data.get("price", "ØºÙŠØ± Ù…ØªÙˆÙØ±")
            }
    except Exception as e:
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†: {e}")
        return {}

# --- Telegram Communication ---

async def send_token_report(update: Update, context: ContextTypes.DEFAULT_TYPE, token: dict, session: aiohttp.ClientSession):
    if not is_authorized_chat(update):
        return  # Ù„Ø§ ØªØ±Ø³Ù„ Ø´ÙŠØ¦Ù‹Ø§ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØµØ±Ø­Ø©

    address = token.get("address")
    name = token.get("name", "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ")
    image_url = token.get("image")

    if not address or not await check_rug(session, address):
        logging.info(f"Ø§Ù„ØªÙˆÙƒÙ† {name} ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Rug Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ù…ÙÙ‚ÙˆØ¯.")
        return

    analysis = await analyze_token(session, address)
    if not analysis:
        logging.info(f"ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ† {name}.")
        return

    # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø®Ø§ØµØ© Ù„Ù€ Markdown V2
    name = name.replace("_", "\\_").replace("*", "\\*").replace("[", "\\[").replace("`", "\\`")
    address = address.replace("_", "\\_").replace("*", "\\*").replace("[", "\\[").replace("`", "\\`")

    message = f"""
ğŸš€ ØªÙˆÙƒÙ† Ø¬Ø¯ÙŠØ¯: *{name}*
ğŸ†” Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: `{address}`

âœ… ÙØ­Øµ Rug: Ø¬ÙŠØ¯
ğŸ“Š Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: {analysis['liquidity']}$
ğŸ‘¥ Ø§Ù„Ø­Ø§Ø¦Ø²ÙˆÙ†: {analysis['owners']}
ğŸ“ˆ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©: {analysis['market_cap']}$
ğŸ’° Ø§Ù„Ø³Ø¹Ø±: {analysis['price']} SOL
â³ Ø¹Ù…Ø± Ø§Ù„Ø¹Ù‚Ø¯: {analysis['age']}
ğŸ“‰ Ø§Ù„Ø§ØªØ¬Ø§Ù‡: {analysis['trend']}

ğŸ”— [Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙˆÙƒÙ†](https://pump.fun/token/{address})
"""

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("ğŸ›’ Ø´Ø±Ø§Ø¡", callback_data=f"buy_{address}"),
         InlineKeyboardButton("âŒ ØªØ¬Ø§Ù‡Ù„", callback_data=f"ignore_{address}")]
    ])

    try:
        if image_url:
            await context.bot.send_photo(
                chat_id=update.effective_chat.id,
                photo=image_url,
                caption=message,
                parse_mode=ParseMode.MARKDOWN_V2,
                reply_markup=keyboard
            )
        else:
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text=message,
                parse_mode=ParseMode.MARKDOWN_V2,
                reply_markup=keyboard
            )
    except Exception as e:
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {e}")
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text="âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙˆÙƒÙ†.",
            parse_mode=ParseMode.MARKDOWN_V2
        )

# --- Monitor New Tokens ---

async def monitor_tokens(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_authorized_chat(update):
        await update.message.reply_text("ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§.", parse_mode=ParseMode.MARKDOWN_V2)
        return

    sent_tokens = load_sent_tokens()
    async with aiohttp.ClientSession() as session:
        while not context.user_data.get("stop_monitor", False):
            tokens = await get_new_tokens(session)
            for token in tokens:
                address = token.get("address")
                if address and address not in sent_tokens:
                    await send_token_report(update, context, token, session)
                    sent_tokens.add(address)
                    save_sent_tokens(sent_tokens)
            await asyncio.sleep(30)

# --- Telegram Commands ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_authorized_chat(update):
        await update.message.reply_text("ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§.", parse_mode=ParseMode.MARKDOWN_V2)
        return
    context.user_data["stop_monitor"] = False
    await update.message.reply_text("ğŸ“¡ ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª. Ø³ØªØµÙ„Ùƒ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª.", parse_mode=ParseMode.MARKDOWN_V2)
    context.application.create_task(monitor_tokens(update, context))

async def stop(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_authorized_chat(update):
        await update.message.reply_text("ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§.", parse_mode=ParseMode.MARKDOWN_V2)
        return
    context.user_data["stop_monitor"] = True
    await update.message.reply_text("ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©.", parse_mode=ParseMode.MARKDOWN_V2)

async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    if not is_authorized_chat(update):
        await query.message.reply_text("ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§.", parse_mode=ParseMode.MARKDOWN_V2)
        return
    try:
        action, token_id = query.data.split("_", 1)
        await query.edit_message_reply_markup(reply_markup=None)
        if action == "buy":
            await query.message.reply_text(f"âœ… Ø´Ø±Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙ†: `{token_id}`", parse_mode=ParseMode.MARKDOWN_V2)
        elif action == "ignore":
            await query.message.reply_text(f"ğŸš« ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªÙˆÙƒÙ†: `{token_id}`", parse_mode=ParseMode.MARKDOWN_V2)
    except ValueError:
        logging.error(f"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØºÙŠØ± ØµØ§Ù„Ø­Ø©: {query.data}")
        await query.message.reply_text("âš ï¸ Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± ØµØ§Ù„Ø­.", parse_mode=ParseMode.MARKDOWN_V2)

# --- Main Entry ---

def main():
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("stop", stop))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.run_polling()

if __name__ == "__main__":
    main()
